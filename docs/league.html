<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <link rel="stylesheet" href="./css/datatables.css">

  <title>DPC Fantasy Tracker · Hawkie</title>
</head>

<body class="bg-light">
  <div class="container">
    <h1 id="league-title" class="display-3 text-center my-4"></h1>

    <ul class="nav justify-content-center my-4 lead">
      <li class="nav-item">
        <a class="nav-link link-dark" data-bs-toggle="tab" data-bs-target="#tab-schedule" href="">Schedule</a>
      </li>
      <li class="nav-item">
        <a class="nav-link link-dark" data-bs-toggle="tab" data-bs-target="#tab-aggregate" href="">Results Overview</a>
      </li>
      <li class="nav-item">
        <a class="nav-link link-dark" data-bs-toggle="tab" data-bs-target="#tab-average" href="">Average Results</a>
      </li>
      <li class="nav-item">
        <a class="nav-link link-dark" data-bs-toggle="tab" data-bs-target="#tab-single" href="">Single Results</a>
      </li>
      <li class="nav-item">
        <a class="nav-link link-dark" data-bs-toggle="tab" data-bs-target="#tab-note" href="">Known Issues</a>
      </li>
    </ul>

    <div class="tab-content my-4">
      <div class="tab-pane fade show active" id="tab-schedule" role="tabpanel">
        <div id="roster-lock-grid" class="row justify-content-center row-cols-2 row-cols-md-3 row-cols-xl-4 row-cols-xxl-6 g-4 mb-4"></div>
        <div class="bg-white p-3 my-4 border rounded">
          <h3 class="text-center">Schedule</h3>
          <table id="table-schedule" class="table nowrap table-hover" style="width: 100%"></table>
        </div>
      </div>
      <div class="tab-pane fade" id="tab-note" role="tabpanel">
        <div class="bg-white p-3 my-4 border rounded">
          <h3 class="text-center">Known Issues</h3>
          <ul>
            <li>Valve does not count the final 5–10 seconds of the game for fantasy points. Please see this <a href="https://www.reddit.com/r/DotA2/comments/rcda9n/valve_your_fantasy_point_math_is_incorrect_with/" target="_blank">Reddit post</a> for
              more information. This can result in slight differences between the numbers presented here and those in-game.</li>
            <li>Some replays are unavailable, and therefore I am unable to calculate the fantasy points earned in those games. This can result in major differences in the <em>Results Overview</em> table, as well as missing records in the <em>Single
                Results</em>
              table. Unfortunately, there is nothing I can do about this. Fortunately, this is quite rare.</li>
          </ul>
        </div>
      </div>
      <div class="tab-pane fade" id="tab-single" role="tabpanel">
        <div class="bg-white p-3 my-4 border rounded">
          <h3 class="text-center">Single Results</h3>
          <table id="table-single" class="table nowrap table-hover" style="width: 100%"></table>
        </div>
      </div>
      <div class="tab-pane fade" id="tab-average" role="tabpanel">
        <div class="bg-white p-3 my-4 border rounded">
          <h3 class="text-center">Average Results</h3>
          <table id="table-average" class="table nowrap table-hover" style="width: 100%"></table>
        </div>

      </div>
      <div class="tab-pane fade" id="tab-aggregate" role="tabpanel">
        <div class="bg-white p-3 my-4 border rounded">
          <h3 class="text-center">Results Overview</h3>
          <table id="table-aggregate" class="table nowrap table-hover" style="width: 100%"></table>
        </div>
      </div>
    </div>

    <footer class="d-flex justify-content-center align-items-center pt-2 mt-4 border-top">
      <p class="text-center">Created by Hawkie. Powered by OpenDota and datdota.</p>
    </footer>
  </div>

  <script src=" https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/v/bs5/jq-3.6.0/dt-1.11.3/fc-4.0.1/fh-3.2.0/datatables.min.js"></script>

  <script>
    let params = new URLSearchParams(window.location.search);
    var leagueId = params.get("id");

    fetch("./data/" + leagueId + ".json")
      .then(response => response.json())
      .then(function(leagueData) {
        // Add league title
        document.querySelector("#league-title").innerHTML = leagueData.name;

        // Render the roster lock countdowns
        leagueData.roster_lock.forEach(function(period, i) {
          var col = document.createElement("div");
          col.className = "col";

          var container = document.createElement("div");
          container.className = "text-center p-2 bg-white border rounded";

          var title = document.createElement("div");
          title.className = "small";
          title.innerHTML = "Period " + (i + 1) + " · " + new Date(period.start_time * 1000)
            .toLocaleDateString(
              'en-gb', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                timeZone: 'utc'
              });

          var content = document.createElement("div");
          content.className = "fs-4 fw-bold";
          setInterval(function() {
            difference = period.start_time * 1000 - new Date();
            if (difference <= 0) {
              content.innerHTML = "Locked";
            } else {
              var hours = Math.floor(difference / 3600000);
              var minutes = Math.floor((difference % 3600000) / 60000);
              var seconds = Math.floor((difference % 60000) / 1000);
              content.innerHTML = hours + "h " + minutes + "m " + seconds + "s";
            }
          }, 1000);

          container.append(title);
          container.append(content);
          col.append(container);

          document.querySelector("#roster-lock-grid").append(col);
        });

        // Set common table options
        var tableOptions = {
          paging: false,
          fixedHeader: true,
          fixedColumns: {
            left: 1,
            right: 1
          },
          scrollX: true
        }

        // Render the schedule table
        var tableSchedule = {
          ...tableOptions,
          fixedColumns: 1,
          data: leagueData.schedule.filter(match => match.time != 0),
          createdRow: function(row, data) {
            if (new Date().getTime() > data.time * 1000) $(row).addClass('text-decoration-line-through');
          },
          columns: [{
              title: "Match",
              data: "node_name"
            },
            {
              title: "Team 1",
              data: "team_name_1"
            },
            {
              title: "Team 2",
              data: "team_name_2"
            },
            {
              title: "Scheduled Time (UTC)",
              data: "time",
              type: "date",
              className: "text-end"
            }
          ],
          columnDefs: [{
              render: data => data == "NA" ? "" : data,
              targets: 0
            },
            {
              render: data => data == "NA" ? "TBD" : data,
              targets: [1, 2]
            },
            {
              render: data => new Date(data * 1000).toLocaleTimeString(
                'en-gb', {
                  year: 'numeric',
                  month: 'short',
                  day: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit',
                  timeZone: 'utc'
                }),
              targets: 3
            }
          ],
          order: [
            [3, 'asc']
          ],
        };

        // Render the aggregate table
        var periods = Object.keys(leagueData.result_aggregate[0]).filter(d => d.startsWith("period_"));
        columns = [{
            title: "Player Name",
            data: "player_name"
          },
          {
            title: "Team Name",
            data: "team_name"
          },
          {
            title: "Player Role",
            data: "player_role"
          }
        ];
        for (period of periods) {
          columns.push({
            title: period.replace(/^_*(.)|_+(.)/g, (match, p1, p2) => p1 ? p1.toUpperCase() : ' ' + p2.toUpperCase()),
            data: period,
            type: "num",
            className: "text-end"
          })
        };
        columns.push({
          title: "Total",
          data: "total",
          type: "num",
          className: "text-end"
        });

        var tableAggregate = {
          ...tableOptions,
          data: leagueData.result_aggregate,
          columns: columns,
          columnDefs: [{
              render: data => data,
              targets: [0, 1, 2]
            },
            {
              render: data => data == "NA" ? "0.00" : data.toFixed(2),
              targets: "_all"
            }
          ],
          order: [
            [periods.length + 3, 'desc']
          ],
        };

        // Render the average table
        var tableAverage = {
          ...tableOptions,
          data: leagueData.result_average,
          columns: [{
              title: "Player Name",
              data: "player_name"
            },
            {
              title: "Team Name",
              data: "team_name"
            },
            {
              title: "Player Role",
              data: "player_role"
            },
            {
              title: "Kills",
              data: "kills",
              className: "text-end"
            },
            {
              title: "Deaths",
              data: "deaths",
              className: "text-end"
            },
            {
              title: "Creep Score",
              data: "creep_score",
              className: "text-end"
            },
            {
              title: "GPM",
              data: "gold_per_min",
              className: "text-end"
            },
            {
              title: "Tower Kills",
              data: "tower_kills",
              className: "text-end"
            },
            {
              title: "Roshan Kills",
              data: "roshan_kills",
              className: "text-end"
            },
            {
              title: "Teamfight",
              data: "team_fight",
              className: "text-end"
            },
            {
              title: "Obs Wards",
              data: "obs_wards_planted",
              className: "text-end"
            },
            {
              title: "Camps Stacked",
              data: "camps_stacked",
              className: "text-end"
            },
            {
              title: "Runes Grabbed",
              data: "runes_grabbed",
              className: "text-end"
            },
            {
              title: "First Blood",
              data: "first_blood",
              className: "text-end"
            },
            {
              title: "Stuns",
              data: "stuns",
              className: "text-end"
            },
            {
              title: "Total",
              data: "total",
              className: "text-end"
            }
          ],
          columnDefs: [{
            render: data => data == "NA" ? "0.00" : data.toFixed(2),
            targets: [3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15]
          }],
          order: [
            [1, 'asc'],
            [2, 'asc']
          ]
        };

        // Render the single table
        var tableSingle = {
          ...tableOptions,
          data: leagueData.result_single,
          columns: [{
              title: "Player Name",
              data: "player_name"
            },
            {
              title: "Team Name",
              data: "team_name"
            },
            {
              title: "Player Role",
              data: "player_role"
            },
            {
              title: "Match ID",
              data: "match_id"
            },
            {
              title: "Match Time (UTC)",
              data: "start_time",
              type: "date"
            },
            {
              title: "Kills",
              data: "kills",
              className: "text-end"
            },
            {
              title: "Deaths",
              data: "deaths",
              className: "text-end"
            },
            {
              title: "Creep Score",
              data: "creep_score",
              className: "text-end"
            },
            {
              title: "GPM",
              data: "gold_per_min",
              className: "text-end"
            },
            {
              title: "Tower Kills",
              data: "tower_kills",
              className: "text-end"
            },
            {
              title: "Roshan Kills",
              data: "roshan_kills",
              className: "text-end"
            },
            {
              title: "Teamfight",
              data: "team_fight",
              className: "text-end"
            },
            {
              title: "Obs Wards",
              data: "obs_wards_planted",
              className: "text-end"
            },
            {
              title: "Camps Stacked",
              data: "camps_stacked",
              className: "text-end"
            },
            {
              title: "Runes Grabbed",
              data: "runes_grabbed",
              className: "text-end"
            },
            {
              title: "First Blood",
              data: "first_blood",
              className: "text-end"
            },
            {
              title: "Stuns",
              data: "stuns",
              className: "text-end"
            },
            {
              title: "Total",
              data: "total",
              className: "text-end"
            }
          ],
          columnDefs: [{
              render: function(data) {
                return "<a href='https://www.opendota.com/matches/" + data + "/fantasy' target='_blank'>" + data +
                  "</a>";
              },
              targets: 3
            },
            {
              render: function(data) {
                return new Date(data * 1000).toLocaleTimeString(
                  'en-gb', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    timeZone: 'utc'
                  });
              },
              targets: 4
            },
            {
              render: data => data.toFixed(0),
              targets: [9, 10, 15]
            },
            {
              render: data => data.toFixed(1),
              targets: [5, 6, 12, 13]
            },
            {
              render: data => data.toFixed(2),
              targets: [7, 8, 11, 14, 16, 17]
            },
            {
              visible: false,
              targets: []
            }
          ],
          order: [
            [4, 'desc'],
            [1, 'asc'],
            [2, 'asc']
          ]
        };

        // Ensure datatable is properly rendered
        var countSchedule = 0;
        $("a[data-bs-target='#tab-schedule']").on("shown.bs.tab", function() {
          if (countSchedule == 0) {
            $("#table-schedule").DataTable(tableSchedule);
          }
          countSchedule++;
        });
        var countAggregate = 0;
        $("a[data-bs-target='#tab-aggregate']").on("shown.bs.tab", function() {
          if (countAggregate == 0) {
            $("#table-aggregate").DataTable(tableAggregate);
          }
          countAggregate++;
        });
        var countAverage = 0;
        $("a[data-bs-target='#tab-average']").on("shown.bs.tab", function() {
          if (countAverage == 0) {
            $("#table-average").DataTable(tableAverage);
          }
          countAverage++;
        });
        var countSingle = 0;
        $("a[data-bs-target='#tab-single']").on("shown.bs.tab", function() {
          if (countSingle == 0) {
            $("#table-single").DataTable(tableSingle);
          }
          countSingle++;
        });
        $("a[data-bs-target='#tab-schedule']").tab("show")

        // Fix header column widths
        $("a[data-bs-toggle='tab']").on("shown.bs.tab", function() {
          $($.fn.dataTable.tables()).DataTable().fixedHeader.adjust().draw();
        });

        // Show errors in console instead of as alerts
        $.fn.dataTable.ext.errMode = 'throw';
      });
  </script>
</body>

</html>
