<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <link rel="stylesheet" href="./css/datatables.css">

  <title>DPC Fantasy Tracker · Hawkie</title>
</head>

<body>
  <div class="container">
    <h1 id="league-title" class="display-3 text-center mt-4 mb-4"></h1>

    <ul class="nav justify-content-center mt-4 mb-4" role="tablist">
      <li class="btn-group" role="presentation">
        <button class="btn btn-outline-dark active" data-bs-toggle="tab" data-bs-target="#tab-aggregate" type="button" role="tab">Aggregate Performance</button>
        <button class="btn btn-outline-dark" data-bs-toggle="tab" data-bs-target="#tab-single" type="button" role="tab">Single Performances</button>
      </li>
    </ul>
    <div class="tab-content">
      <div class="tab-pane fade show active" id="tab-aggregate" role="tabpanel" aria-labelledby="tab-aggregate-tab">
        <table id="table-aggregate" class="table nowrap table-hover" style="width: 100%;"></table>
      </div>
      <div class="tab-pane fade" id="tab-single" role="tabpanel" aria-labelledby="tab-single-tab">
        <table id="table-single" class="table nowrap table-hover" style="width: 100%;"></table>
      </div>
    </div>

    <footer class="d-flex justify-content-center align-items-center pt-2 mt-4 border-top">
      <p class="text-center text-muted">Created by Hawkie. Powered by OpenDota and datdota.</p>
    </footer>
  </div>

  <script src=" https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/v/dt/jq-3.6.0/dt-1.11.3/fc-4.0.1/fh-3.2.0/datatables.min.js"></script>

  <script>
    let params = new URLSearchParams(window.location.search);
    var leagueId = params.get("id");

    fetch("./data/" + leagueId + ".json")
      .then(response => response.json())
      .then(function(league_data) {
        // Add league title
        document.querySelector("#league-title").innerHTML = league_data.name;

        // Render the aggregate table
        var periods = Object.keys(league_data.result_aggregate[0]).filter(d => d.startsWith("period_"));
        tableColumns = [{
            title: "Player Name",
            data: "player_name"
          },
          {
            title: "Team Name",
            data: "team_name"
          },
          {
            title: "Player Role",
            data: "player_role"
          }
        ];
        for (var i = 1; i < periods.length + 1; i++) {
          tableColumns.push({
            title: "Period " + i,
            data: "period_" + i,
            type: "num",
            className: "text-end"
          })
        }

        var tableAggregate = {
          paging: false,
          fixedHeader: true,
          fixedColumns: true,
          scrollX: true,
          data: league_data.result_aggregate,
          columns: tableColumns,
          columnDefs: [{
              render: data => data,
              targets: [0, 1, 2]
            },
            {
              render: function(data) {
                if (!isNaN(data)) {
                  return data.toFixed(2);
                } else if (data == "NA") {
                  return "—";
                } else {
                  return data;
                }
              },
              targets: "_all"
            }
          ],
          order: [
            [1, 'asc'],
            [2, 'asc']
          ],
        };

        // Render the single table
        var tableSingle = {
          paging: false,
          fixedHeader: true,
          fixedColumns: true,
          scrollX: true,
          data: league_data.result_single,
          columns: [{
              title: "Player Name",
              data: "player_name"
            },
            {
              title: "Team Name",
              data: "team_name"
            },
            {
              title: "Player Role",
              data: "player_role"
            },
            {
              title: "Match ID",
              data: "match_id"
            },
            {
              title: "Match Time (UTC)",
              data: "start_time",
              type: "date"
            },
            {
              title: "Kills",
              data: "kills",
              className: "text-end"
            },
            {
              title: "Deaths",
              data: "deaths",
              className: "text-end"
            },
            {
              title: "Creep Score",
              data: "creep_score",
              className: "text-end"
            },
            {
              title: "GPM",
              data: "gold_per_min",
              className: "text-end"
            },
            {
              title: "Tower Kills",
              data: "tower_kills",
              className: "text-end"
            },
            {
              title: "Roshan Kills",
              data: "roshan_kills",
              className: "text-end"
            },
            {
              title: "Teamfight",
              data: "team_fight",
              className: "text-end"
            },
            {
              title: "Obs Wards",
              data: "obs_wards_planted",
              className: "text-end"
            },
            {
              title: "Camps Stacked",
              data: "camps_stacked",
              className: "text-end"
            },
            {
              title: "Runes Grabbed",
              data: "runes_grabbed",
              className: "text-end"
            },
            {
              title: "First Blood",
              data: "first_blood",
              className: "text-end"
            },
            {
              title: "Stuns",
              data: "stuns",
              className: "text-end"
            },
            {
              title: "Total",
              data: "total",
              className: "text-end"
            }
          ],
          columnDefs: [{
              render: function(data) {
                return "<a href='https://www.opendota.com/matches/" + data + "/fantasy' target='_blank'>" + data +
                  "</a>";
              },
              targets: 3
            },
            {
              render: function(data) {
                return new Date(data * 1000).toLocaleTimeString(
                  'en-gb', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    timeZone: 'utc'
                  });
              },
              targets: 4
            },
            {
              render: data => data.toFixed(0),
              targets: [9, 10, 15]
            },
            {
              render: data => data.toFixed(1),
              targets: [5, 6, 12, 13]
            },
            {
              render: data => data.toFixed(2),
              targets: [7, 8, 11, 14, 16, 17]
            },
            {
              visible: false,
              targets: []
            }
          ],
          order: [
            [4, 'desc'],
            [1, 'asc'],
            [2, 'asc']
          ]
        };

        // Ensure datatable is properly rendered
        $("#table-aggregate").DataTable(tableAggregate);
        var count = 0;
        $("button[data-bs-target='#tab-single']").on("shown.bs.tab", function() {
          if (count == 0) {
            $("#table-single").DataTable(tableSingle);
          }
          count++;
        });

        // Fix header column widths
        $("button[data-bs-toggle='tab']").on("shown.bs.tab", function() {
          $($.fn.dataTable.tables()).DataTable().fixedHeader.adjust().draw();
        });

      });
  </script>
</body>

</html>
